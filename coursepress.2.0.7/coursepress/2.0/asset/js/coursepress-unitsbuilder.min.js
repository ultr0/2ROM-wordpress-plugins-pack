/*! CoursePress - v2.0.7
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2017; * Licensed GPLv2+ */
var CoursePress=CoursePress||{};!function(a){function b(){CoursePress.UnitBuilder=new CoursePress.Views.UnitBuilder({el:"#unit-builder"})}CoursePress.Views=CoursePress.Views||{},CoursePress.Models=CoursePress.Models||{},CoursePress.Collections=CoursePress.Collections||{},CoursePress.Helpers=CoursePress.Helpers||{},CoursePress.Helpers.Module=CoursePress.Helpers.Module||{},CoursePress.Helpers.Module.quiz=CoursePress.Helpers.Module.quiz||{},CoursePress.Helpers.Module.form=CoursePress.Helpers.Module.form||{},CoursePress.Helpers.Module.refresh_ui=function(){a.each(a(".unit-builder-modules .editor"),function(b,c){var d=a(c).attr("id");if(void 0===tinyMCE.editors[d]){var e=a("#"+d).val(),f=a(c).attr("name"),g=a(c).attr("data-height")?a(c).attr("data-height"):400;CoursePress.editor.create(c,d,f,e,!1,g)}}),a(".unit-builder-modules").hasClass("ui-accordion")&&a(".unit-builder-modules").accordion("destroy");var b=0;if(CoursePress.UnitBuilder.activeModuleRef&&CoursePress.UnitBuilder.activeModuleRef.length>0){var c=a('[data-cid="'+CoursePress.UnitBuilder.activeModuleRef+'"]')[0];b=parseInt(a(c).attr("data-order"))-1}a(".unit-builder-modules").accordion({heightStyle:"content",collapsible:!0,header:"> div > h3",active:b}).sortable({axis:"y",handle:"h3",stop:function(b,c){c.item.children("h3").triggerHandler("focusout",c);var d=a(".module-holder");a.each(d,function(b,c){var d=parseInt(a(c).attr("data-order")),e=b+1,f=a(c).attr("data-cid");a(c).attr("data-order",e),d!==e&&(CoursePress.UnitBuilder.module_collection._byId[f].set_meta("module_order",e),a(c).addClass("dirty"))}),a(this).accordion("refresh")}}),a(".unit-builder-tabs ul").sortable({stop:function(){var b=a(".unit-builder-tabs ul li");a.each(b,function(b,c){var d=parseInt(a(c).attr("data-order")),e=b+1,f=a(c).attr("data-cid");if(a(c).attr("data-order",e),d!==e){var g=CoursePress.UnitBuilder.unit_collection._byId[f].get("meta");g.unit_order=e,CoursePress.UnitBuilder.unit_collection._byId[f].set("meta",g),CoursePress.UnitBuilder.unit_collection._byId[f].set("flag","dirty"),a(c).addClass("dirty")}})}}),a(".button.browse-media-field").browse_media_field(),a(".unit-builder-pager ul li").removeClass("active"),a('.unit-builder-pager ul li[data-page="'+CoursePress.UnitBuilder.activePage+'"]').addClass("active"),"publish"===CoursePress.UnitBuilder.activeUnitStatus?(a("#unit-live-toggle").removeClass("off"),a("#unit-live-toggle").addClass("on"),a("#unit-live-toggle-2").removeClass("off"),a("#unit-live-toggle-2").addClass("on")):(a("#unit-live-toggle").removeClass("on"),a("#unit-live-toggle").addClass("off"),a("#unit-live-toggle-2").removeClass("on"),a("#unit-live-toggle-2").addClass("off"));var d=CoursePress.UnitBuilder.unit_collection.get(CoursePress.UnitBuilder.activeUnitRef),e=d&&d.get("user_cap")?d.get("user_cap"):{},f=e.coursepress_change_unit_status_cap;a(".coursepress-ui-toggle-switch").each(function(){var b=a(this),c=b.attr("name"),d=!0;"publish-course-toggle"===c&&(CoursePress.current_user_can("coursepress_change_status_cap")||(d=!1)),"unit-live-toggle"!==c&&"unit-live-toggle-2"!==c||f||(d=!1,b.unbind("click")),d&&b.coursepress_ui_toggle()}),CoursePress.UnitBuilder.$el.find(".unit-delete-button")[e.coursepress_delete_course_units_cap?"show":"hide"](),1===CoursePress.UnitBuilder.totalPages?a(".unit-delete-page-button").addClass("hidden"):a(".unit-delete-page-button").removeClass("hidden"),a(".unit-builder-pager ul li[data-page]").droppable({activeClass:"page-droppable",hoverClass:"page-droppable-hover",accept:".unit-builder-modules .group",tolerance:"pointer",drop:function(b,c){var d=b.target,e=parseInt(a(d).attr("data-page")),f=CoursePress.UnitBuilder.activePage,g=c.draggable;if(f!==e){var h=a(a(g).find(".module-holder")[0]).attr("data-cid"),i=CoursePress.UnitBuilder.module_collection._byId[h].get("meta");i.module_page=e,i.module_order=i.module_order+900,CoursePress.UnitBuilder.module_collection._byId[h].set("meta",i),CoursePress.UnitBuilder.module_collection._byId[h].trigger("change",CoursePress.UnitBuilder.module_collection._byId[h]),a(g).detach()}}}),a(".dateinput").datepicker({dateFormat:"yy-mm-dd"}),a(".date").off("sync"),a(".date").on("click",function(){a(this).find(".dateinput").datepicker("show")});var g=a(".button-add-new-unit");g=g.length>0?g.position().top+a(".button-add-new-unit").innerHeight()+20:0;var h=parseFloat(a("#unit-builder .tab-content").css("min-height").replace("px",""));h<818&&(h=818,a("#unit-builder .tab-content").css("min-height",h+"px")),h<g&&a("#unit-builder .tab-content").css("min-height",g+"px"),a(".unit-builder-body .quiz-action-button").off("click"),a(".unit-builder-body .quiz-action-button").on("click",function(){var b=this,c=a(b).parents(".module-components")[0],d=a(b).parents(".module-holder")[0],e=a(c).find(".quiz-question"),f=e.length,g=a(b).attr("data-type"),h='<div class="quiz-question question-'+(f+1)+'" data-id="'+(f+1)+'" data-type="'+g+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">';h+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var i="",j='<div class="question-answer">';switch(g){case"single":var k="single-"+(f+1);i=_coursepress.unit_builder.question_type.single,j+='<div class="answer-group">',j+='<div class="answer"><input type="radio" name="'+k+'" value="" />',j+='<input class="component-radio-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.a+'" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',j+='<div class="answer"><input type="radio" name="'+k+'" value="" />',j+='<input class="component-radio-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.b+'" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',j+="</div>",j+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"multiple":i=_coursepress.unit_builder.question_type.multiple,j+='<div class="answer-group">',j+='<div class="answer"><input type="checkbox" name="" value="" />',j+='<input class="component-checkbox-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.a+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',j+='<div class="answer"><input type="checkbox" name="" value="" />',j+='<input class="component-checkbox-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.b+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>',j+="</div>",j+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"short":i=_coursepress.unit_builder.question_type.short,j+='<div class="answer-group">',j+='<label data-key="label" class="wide">',j+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",j+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",j+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="" />',j+="</label>",j+="</div>",j+="</div>";break;case"long":i=_coursepress.unit_builder.question_type.long,j+='<div class="answer-group">',j+='<label data-key="label" class="wide">',j+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",j+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",j+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="" />',j+="</label>",j+="</div>",j+="</div>"}j+="</div>",h+='<label class="wide" data-key="label"><span class="label">'+i+":</span></label>",h+="<textarea></textarea>",h+=j,h+="</div>",a(c).append(h),CoursePress.Helpers.Module.quiz.update_meta(d),CoursePress.Helpers.Module.quiz.bind_buttons()}),CoursePress.Helpers.Module.quiz.bind_add_item(),CoursePress.Helpers.Module.form.bind_buttons(),a(".unit-builder-body .form-action-button").off("click"),a(".unit-builder-body .form-action-button").on("click",function(){var b=this,c=a(b).parents(".module-components")[0],d=a(b).parents(".module-holder")[0],e=a(c).find(".quiz-question"),f=e.length,g=a(b).attr("data-type"),h='<div class="quiz-question question-'+(f+1)+'" data-id="'+(f+1)+'" data-type="'+g+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">';h+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var i="",j='<div class="question-answer">';switch(g){case"short":i=_coursepress.unit_builder.question_type.short,j+='<div class="answer-group">',j+='<label data-key="label" class="wide">',j+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",j+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",j+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="" />',j+="</label>",j+="</div>",j+="</div>";break;case"long":i=_coursepress.unit_builder.question_type.long,j+='<div class="answer-group">',j+='<label data-key="label" class="wide">',j+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",j+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",j+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="" />',j+="</label>",j+="</div>",j+="</div>";break;case"selectable":var k="selectable-"+(f+1);i=_coursepress.unit_builder.question_type.selectable,j+='<div class="answer-group">',j+='<div class="answer"><input type="radio" name="'+k+'" value="" />',j+='<input class="component-select-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.a+'" /><span class="remove-form-item"><i class="fa fa-trash-o"></i></span></div>',j+='<div class="answer"><input type="radio" name="'+k+'" value="" />',j+='<input class="component-select-answer wide" type="text" value="'+_coursepress.unit_l8n.pre_answers.b+'" /><span class="remove-form-item"><i class="fa fa-trash-o"></i></span></div>',j+="</div>",j+='<a class="add-form-item">'+_coursepress.unit_builder_add_answer_label+"</a>"}j+="</div>",h+='<label class="wide" data-key="label"><span class="label">'+i+":</span></label>",h+="<textarea></textarea>",h+=j,h+="</div>",a(c).append(h),CoursePress.Helpers.Module.form.update_meta(d),CoursePress.Helpers.Module.form.bind_buttons()}),CoursePress.Helpers.Module.form.bind_buttons(),a(".module-use-timer input, .module-assessable input").on("change",function(){var b=a(this),c=b.is(":checked");a(b.data("target"),b.parents(".module-header").first()).find("input").attr("readonly",!c)}).change()},CoursePress.Helpers.Module.quiz.render_component=function(b){var c=b.get_meta("questions");if(void 0===c||c.length<=0)return"";var d="";return a.each(c,function(b,c){d+='<div class="quiz-question question-'+(b+1)+'" data-id="'+(b+1)+'" data-type="'+c.type+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">',d+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var e="",f='<div class="question-answer">';switch(c.type){case"single":e=_coursepress.unit_builder.question_type.single,f+='<div class="answer-group">',c.options.answers=c.options.answers||[],a.each(c.options.answers,function(a,d){var e=c.options.checked[a]?"checked=checked":"";f+='<div class="answer"><input type="radio" name="question'+(b+1)+'" value="" '+e+" />",f+='<input class="component-radio-answer wide" type="text" value="'+d+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>'}),f+="</div>",f+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"multiple":e=_coursepress.unit_builder.question_type.multiple,f+='<div class="answer-group">',a.each(c.options.answers,function(a,b){var d=c.options.checked[a]?"checked=checked":"";f+='<div class="answer"><input type="checkbox" name="" value="" '+d+" />",f+='<input class="component-checkbox-answer wide" type="text" value="'+b+'" name="" /><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>'}),f+="</div>",f+='<a class="add-quiz-item">'+_coursepress.unit_builder_add_answer_label+"</a>"}f+="</div>",d+='<label class="wide" data-key="label"><span class="label">'+e+":</span></label>",d+="<textarea>"+c.question+"</textarea>",d+=f,d+="</div>"}),d},CoursePress.Helpers.Module.quiz.update_meta=function(b){var c=a(b).attr("data-cid"),d={},e=CoursePress.UnitBuilder.module_collection._byId[c],f=a(b).find(".quiz-question");a.each(f,function(b,c){var e;switch(d[b]={type:a(c).attr("data-type"),question:a(c).find("textarea").val(),options:{}},d[b].type){case"single":d[b].options.answers=[],d[b].options.checked=[],e=a(c).find(".answer-group .answer"),a.each(e,function(c,e){d[b].options.answers[c]=a(e).find('[type="text"]').val(),d[b].options.checked[c]=a(e).find('[type="radio"]').is(":checked")});break;case"multiple":d[b].options.answers=[],d[b].options.checked=[],e=a(c).find(".answer-group .answer"),a.each(e,function(c,e){d[b].options.answers[c]=a(e).find('[type="text"]').val(),d[b].options.checked[c]=a(e).find('[type="checkbox"]').is(":checked")})}}),e.set_meta("questions",d),e.set("flag","dirty")},CoursePress.Helpers.Module.quiz.bind_add_item=function(){a(".quiz-question .add-quiz-item").off("click"),a(".quiz-question .add-quiz-item").on("click",function(){var b=this,c=a(b).parents(".quiz-question")[0],d=a(c).attr("data-type"),e="single"===d?"radio":"checkbox",f="single"===d?"component-radio-answer wide":"component-checkbox-answer wide",g=a(c).attr("data-type")+"-"+a(c).attr("data-id"),h='<div class="answer"><input type="'+e+'" value="" name="'+g+'"><input type="text" name="" value="" class="'+f+'"><span class="remove-quiz-item"><i class="fa fa-trash-o"></i></span></div>';a(c).find(".answer-group").append(h),CoursePress.Helpers.Module.quiz.bind_remove_item(),CoursePress.Helpers.Module.quiz.bind_checkboxes(),CoursePress.Helpers.Module.quiz.bind_textboxes()})},CoursePress.Helpers.Module.quiz.bind_checkboxes=function(){a('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').off("change"),a('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').on("change",function(){var b=a(this).parents(".module-holder")[0];CoursePress.Helpers.Module.quiz.update_meta(b)})},CoursePress.Helpers.Module.quiz.bind_textboxes=function(){a('.quiz-question [type="text"], .quiz-question textarea').off("keyup"),a('.quiz-question [type="text"], .quiz-question textarea').on("keyup",function(){var b=a(this).parents(".module-holder")[0];CoursePress.Helpers.Module.quiz.update_meta(b)})},CoursePress.Helpers.Module.quiz.bind_remove_item=function(){a(".quiz-question .remove-quiz-item").off("click"),a(".quiz-question .remove-quiz-item").on("click",function(){var b=this,c=a(b).parents(".answer")[0],d=a(this).parents(".module-holder")[0];a(c).detach(),CoursePress.Helpers.Module.quiz.update_meta(d)})},CoursePress.Helpers.Module.quiz.bind_remove_question=function(){a(".quiz-question .quiz-question-remove").off("click"),a(".quiz-question .quiz-question-remove").on("click",function(){var b=this,c=a(b).parents(".quiz-question")[0],d=a(c).siblings(".quiz-question"),e=a(this).parents(".module-holder")[0];a.each(d,function(b,c){a(c).attr("class",""),a(c).addClass("quiz-question"),a(c).addClass("question-"+(b+1)),a(c).attr("data-id",b+1)}),a(c).detach(),CoursePress.Helpers.Module.quiz.update_meta(e)})},CoursePress.Helpers.Module.quiz.bind_buttons=function(){CoursePress.Helpers.Module.quiz.bind_add_item(),CoursePress.Helpers.Module.quiz.bind_remove_item(),CoursePress.Helpers.Module.quiz.bind_remove_question(),CoursePress.Helpers.Module.quiz.bind_checkboxes(),CoursePress.Helpers.Module.quiz.bind_textboxes()},CoursePress.Helpers.Module.form.render_component=function(b){var c=b.get_meta("questions");if(void 0===c||c.length<=0)return"";var d="";return a.each(c,function(b,c){d+='<div class="quiz-question question-'+(b+1)+'" data-id="'+(b+1)+'" data-type="'+c.type+'" style="position: relative; border: 1px solid rgba(0,0,0,0.2); margin-top: 10px; padding: 5px;">',d+='<div class="quiz-question-remove" style="position: absolute; top:5px; right:5px; font-weight: bolder; font-size: 1.2em; cursor: pointer;">X</div>';var e="",f='<div class="question-answer">';switch(c.type){case"short":e=_coursepress.unit_builder.question_type.short,f+='<div class="answer-group">',f+='<label data-key="label" class="wide">',f+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",f+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",f+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="'+c.placeholder+'" />',f+="</label>",f+="</div>",f+="</div>";break;case"long":e=_coursepress.unit_builder.question_type.long,f+='<div class="answer-group">',f+='<label data-key="label" class="wide">',f+='<span class="label">'+_coursepress.unit_builder_form_pleaceholder_label+"</span>",f+='<span class="description">'+_coursepress.unit_builder_form_pleaceholder_desc+"</span>",f+='<div class="placeholder"><input class="component-placeholder-text wide" type="text" name="" value="'+c.placeholder+'" />',f+="</label>",f+="</div>",f+="</div>";break;case"selectable":e=_coursepress.unit_builder.question_type.selectable,f+='<div class="answer-group">',c.options.answers=c.options.answers||[],a.each(c.options.answers,function(a,d){var e=c.options.checked[a]?"checked=checked":"";f+='<div class="answer"><input type="radio" name="question'+(b+1)+'" value="" '+e+" />",f+='<input class="component-select-answer wide" type="text" value="'+d+'" name="" /><span class="remove-form-item"><i class="fa fa-trash-o"></i></span></div>'}),f+="</div>",f+='<a class="add-form-item">'+_coursepress.unit_builder_add_answer_label+"</a>"}f+="</div>",d+='<label class="wide" data-key="label"><span class="label">'+e+":</span></label>",d+="<textarea>"+c.question+"</textarea>",d+=f,d+="</div>"}),d},CoursePress.Helpers.Module.form.update_meta=function(b){var c=a(b).attr("data-cid"),d={},e=CoursePress.UnitBuilder.module_collection._byId[c],f=a(b).find(".quiz-question");a.each(f,function(b,c){var e;switch(d[b]={type:a(c).attr("data-type"),question:a(c).find("textarea").val(),options:{}},d[b].type){case"single":d[b].options.answers=[],d[b].options.checked=[],e=a(c).find(".answer-group .answer"),a.each(e,function(c,e){d[b].options.answers[c]=a(e).find('[type="text"]').val(),d[b].options.checked[c]=a(e).find('[type="radio"]').is(":checked")});break;case"multiple":d[b].options.answers=[],d[b].options.checked=[],e=a(c).find(".answer-group .answer"),a.each(e,function(c,e){d[b].options.answers[c]=a(e).find('[type="text"]').val(),d[b].options.checked[c]=a(e).find('[type="checkbox"]').is(":checked")});break;case"short":case"long":d[b].placeholder=a(c).find(".answer-group .placeholder input").val();break;case"selectable":d[b].options.answers=[],d[b].options.checked=[],e=a(c).find(".answer-group .answer"),a.each(e,function(c,e){d[b].options.answers[c]=a(e).find('[type="text"]').val(),d[b].options.checked[c]=a(e).find('[type="radio"]').is(":checked")})}}),e.set_meta("questions",d),e.set("flag","dirty")},CoursePress.Helpers.Module.form.bind_add_item=function(){a(".quiz-question .add-form-item").off("click"),a(".quiz-question .add-form-item").on("click",function(){var b=this,c=a(b).parents(".quiz-question")[0],d=a(c).attr("data-type"),e="single"===d||"selectable"===d?"radio":"checkbox",f="single"===d?"component-radio-answer wide":"component-checkbox-answer wide";"selectable"===d&&(f="component-select-answer wide");var g=a(c).attr("data-type")+"-"+a(c).attr("data-id"),h='<div class="answer"><input type="'+e+'" value="" name="'+g+'"><input type="text" name="" value="" class="'+f+'"><span class="remove-form-item"><i class="fa fa-trash-o"></i></span></div>';a(c).find(".answer-group").append(h),CoursePress.Helpers.Module.form.bind_remove_item(),CoursePress.Helpers.Module.form.bind_checkboxes(),CoursePress.Helpers.Module.form.bind_textboxes()})},CoursePress.Helpers.Module.form.bind_checkboxes=function(){a('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').off("change"),a('.quiz-question [type="checkbox"], .quiz-question [type="radio"]').on("change",function(){var b=a(this).parents(".module-holder")[0];CoursePress.Helpers.Module.form.update_meta(b)})},CoursePress.Helpers.Module.form.bind_textboxes=function(){a('.quiz-question [type="text"], .quiz-question textarea').off("keyup"),a('.quiz-question [type="text"], .quiz-question textarea').on("keyup",function(){var b=a(this).parents(".module-holder")[0];CoursePress.Helpers.Module.form.update_meta(b)})},CoursePress.Helpers.Module.form.bind_remove_item=function(){a(".quiz-question .remove-form-item").off("click"),a(".quiz-question .remove-form-item").on("click",function(){var b=this,c=a(b).parents(".answer")[0],d=a(this).parents(".module-holder")[0];a(c).detach(),CoursePress.Helpers.Module.form.update_meta(d)})},CoursePress.Helpers.Module.form.bind_remove_question=function(){a(".quiz-question .quiz-question-remove").off("click"),a(".quiz-question .quiz-question-remove").on("click",function(){var b=this,c=a(b).parents(".quiz-question")[0],d=a(c).siblings(".quiz-question"),e=a(this).parents(".module-holder")[0];a.each(d,function(b,c){a(c).attr("class",""),a(c).addClass("quiz-question"),a(c).addClass("question-"+(b+1)),a(c).attr("data-id",b+1)}),a(c).detach(),CoursePress.Helpers.Module.form.update_meta(e)})},CoursePress.Helpers.Module.form.bind_buttons=function(){CoursePress.Helpers.Module.form.bind_add_item(),CoursePress.Helpers.Module.form.bind_remove_item(),CoursePress.Helpers.Module.form.bind_remove_question(),CoursePress.Helpers.Module.form.bind_checkboxes(),CoursePress.Helpers.Module.form.bind_textboxes()},CoursePress.Helpers.Module.delete_page=function(b,c,d){console.log(c,d);var e=a("#unit-builder").attr("data-nonce");CoursePress.UnitBuilder.module_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=modules_update_delete_section&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID+"&page="+CoursePress.UnitBuilder.activePage+"&wp_nonce="+e+"&page="+d,Backbone.sync("update",CoursePress.UnitBuilder.module_collection,{success:function(b){a("#unit-builder").attr("data-nonce",b.nonce)},error:function(){}})},CoursePress.Helpers.Module.save_unit=function(b,c){a(".unit-buttons .unit-save-button").prepend('<i class="fa fa-spinner fa-spin save-progress"></i> ');var d=a("#unit-builder").attr("data-nonce"),e=a("#unit-builder").closest("form"),f=a(".component-checkbox-answer, .component-radio-answer, .component-select-answer",e);if(0<f.length){var g=[],h="";if(a.each(f,function(c,d){b=a(d),""===b.val()&&(module_title=a(".module-title .module-title-text",b.closest(".module-holder")).val(),h!==module_title&&(g.push("- "+module_title),h=module_title))}),0<g.length)return a(".save-progress").detach(),alert(_coursepress.unit_builder_form.messages.required_fields+"\n"+g.join("\n")),!1}CoursePress.UnitBuilder.module_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=modules_update&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID+"&page="+CoursePress.UnitBuilder.activePage+"&wp_nonce="+d+"&x=1",Backbone.sync("update",CoursePress.UnitBuilder.module_collection,{success:function(b){a("#unit-builder").attr("data-nonce",b.nonce)},error:function(){}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units_update&course_id="+_coursepress.course_id+"&wp_nonce="+d,Backbone.sync("update",CoursePress.UnitBuilder.unit_collection,{success:function(b){a(".save-progress").detach(),d=b.nonce,a("#unit-builder").attr("data-nonce",d),CoursePress.UnitBuilder.unit_collection.trigger(c,CoursePress.UnitBuilder.unit_collection),CoursePress.Helpers.Module.unit_show_message(_coursepress.unit_builder_form.messages.successfully_saved,"success")},error:function(){a(".save-progress").detach(),a(b.currentTarget).prepend('<i class="fa fa-info-circle save-progress"></i> '),CoursePress.Helpers.Module.unit_show_message(_coursepress.unit_builder_form.messages.error_while_saving,"error")}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id,CoursePress.Helpers.Module.unit_show_message(_coursepress.unit_builder_form.messages.saving_unit,"info")},CoursePress.Helpers.Module.unit_add_show_message=function(b,c){a(".section.unit-builder-components .notice").detach(),a(".section.unit-builder-components .description").after('<div class="notice notice-'+c+'"><p>'+b+"</p></div>"),"success"===c&&setTimeout(function(){a(".section.unit-builder-components .notice").fadeOut()},3e3)},CoursePress.Helpers.Module.unit_show_message=function(b,c){a(".unit-builder-header .unit-buttons .notice, .unit-builder-footer .unit-buttons .notice").detach(),a(".unit-builder-header .unit-buttons, .unit-builder-footer .unit-buttons").prepend('<div class="notice notice-'+c+'"><p>'+b+"</p></div>"),"success"===c&&setTimeout(function(){a(".unit-builder-header .unit-buttons .notice, .unit-builder-footer .unit-buttons .notice").fadeOut()},3e3)},CoursePress.Helpers.Module.toggle_unit_state=function(){var b=a("#unit-builder").attr("data-nonce");this.switch=function(b,c,d){"publish"===b?(a("#unit-live-toggle").removeClass("off"),a("#unit-live-toggle").addClass("on"),a("#unit-live-toggle-2").removeClass("off"),a("#unit-live-toggle-2").addClass("on")):(a("#unit-live-toggle").removeClass("on"),a("#unit-live-toggle").addClass("off"),a("#unit-live-toggle-2").removeClass("on"),a("#unit-live-toggle-2").addClass("off")),CoursePress.UnitBuilder.unit_collection._byId[d].get("post_status")!==b&&(CoursePress.UnitBuilder.unit_collection._byId[d].set("post_status",b),CoursePress.UnitBuilder.unit_collection._byId[d].trigger("change",CoursePress.UnitBuilder.unit_collection._byId[d]),a('.unit-builder-tabs [data-tab="'+c+'"]').removeClass("unit-draft"),a('.unit-builder-tabs [data-tab="'+c+'"]').removeClass("unit-live"),"publish"===b?a('.unit-builder-tabs [data-tab="'+c+'"]').addClass("unit-live"):a('.unit-builder-tabs [data-tab="'+c+'"]').addClass("unit-draft"))};var c=this,d=CoursePress.UnitBuilder.activeUnitID,e=CoursePress.UnitBuilder.activeUnitRef,f=CoursePress.UnitBuilder.unit_collection._byId[e].get("post_status");f="publish"===f?"draft":"publish",CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=unit_toggle&course_id="+_coursepress.course_id+"&wp_nonce="+b+"&state="+f+"&unit_id="+d,Backbone.sync("update",CoursePress.UnitBuilder.unit_collection,{success:function(b){c.switch(b.post_status,d,e),a("#unit-builder").attr("data-nonce",b.nonce),CoursePress.UnitBuilder.activeUnitStatus=b.post_status},error:function(b){c.switch(b.post_status,d,e),a("#unit-builder").attr("data-nonce",b.nonce)}}),CoursePress.UnitBuilder.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id},CoursePress.Helpers.Module.render_module=function(a,b){var c,d,e=_coursepress.unit_builder_module_types,f=_coursepress.unit_builder_module_labels;if(a.module_type()&&_coursepress.unit_builder_templates[a.module_type()].trim().length>0&&(d=JSON.parse(_coursepress.unit_builder_templates[a.module_type()])),void 0===d||void 0===_coursepress.unit_builder_module_types[d.type])return"";d.id=a.get("ID"),d.title=a.get("post_title"),d.duration=a.get_meta("duration"),d.type=a.module_type(),d.mode=e[d.type].mode,d.show_title=a.fix_boolean(a.get_meta("show_title")),d.mandatory=a.fix_boolean(a.get_meta("mandatory")),d.assessable=a.fix_boolean(a.get_meta("assessable")),d.minimum_grade=a.get_meta("minimum_grade",100),d.allow_retries=a.fix_boolean(a.get_meta("allow_retries")),d.retry_attempts=a.get_meta("retry_attempts",0),d.use_timer=a.fix_boolean(a.get_meta("use_timer")),d.instructor_assessable=a.fix_boolean(a.get_meta("instructor_assessable"));var g=a.get("post_excerpt");g=g&&g.length>0?g:a.get("post_content"),g=_.escape(g),d.content=g.trim(),d.order=a.get_meta("order",0),d.page=a.get_meta("page",1),c='<h3 class="module-holder-title '+d.type+'"><span class="label">'+d.title+'</span><span class="module-type">'+e[d.type].title+'</span></h3><div class="module-holder '+d.type+" mode-"+d.mode+'" data-id="'+d.id+'" data-type="'+d.type+'" data-order="'+b+'" data-cid="'+a.cid+'">';var h=d.type;if(e[d.type].body&&"hidden"!==e[d.type].body||!e[d.type].body){if(c+='<div class="module-header">',c+='<div class="module module-title"><h4 class="label">'+f.module_title+'</h4><span class="description">'+f.module_title_desc+'</span><label class="show-title"><input type="checkbox" class="show-title" name="meta_show_title['+a.cid+']" value="1" '+CoursePress.utility.checked(d.show_title,1)+' data-target=".module-title-text"/>'+f.module_show_title_desc+'</label><input class="module-title-text" type="text" name="post_title" value="'+d.title+'" /></div>',c+='<input type="hidden" name="meta_module_type" value="'+d.type+'" />',"input"!==d.mode&&"discussion"!==d.type||(c+='<label class="module-mandatory"><input type="checkbox" name="meta_mandatory['+a.cid+']" value="1" '+CoursePress.utility.checked(d.mandatory,1)+' /><span class="label">'+f.module_mandatory+'</span><span class="description">'+f.module_mandatory_desc+"</span></label>",c+='<label class="module-assessable"><input type="checkbox" data-target=".module-minimum-grade" name="meta_assessable['+a.cid+']" value="1" '+CoursePress.utility.checked(d.assessable,1)+' /><span class="label">'+f.module_assessable+'</span><span class="description">'+f.module_assessable_desc+"</span></label>","input"===d.mode&&(null!=h.match(/input/)&&(c+='<label class="module-use-timer"><input type="checkbox" data-target=".module-duration" name="meta_use_timer['+a.cid+']" value="1" '+CoursePress.utility.checked(d.use_timer,1)+' /><span class="label">'+f.module_use_timer+'</span><br /><span class="description">'+f.module_use_timer_desc+"</span></label>"),c+='<label class="module-allow-retries"><input type="checkbox" name="meta_allow_retries['+a.cid+']" value="1" '+CoursePress.utility.checked(d.allow_retries,1)+' /><span class="label">'+f.module_allow_retries+'</span><input type="number" name="meta_retry_attempts" value="'+d.retry_attempts+'" min="0" class="small-text" /><span class="description">'+f.module_allow_retries_desc+"</span></label>",c+='<label class="module-minimum-grade"><span class="label">'+f.module_minimum_grade+'</span><input type="number" name="meta_minimum_grade" value="'+d.minimum_grade+'" min="0" max="100" class="small-text" /><span class="description">'+f.module_minimum_grade_desc+"</span></label>")),c+='<div class="module module-duration"><h4 class="div">'+f.module_duration+'</h4><input type="text" name="meta_duration" value="'+d.duration+'" /></div>',"input-upload"===h&&(c+='<label class="module-assessable-2"><input type="checkbox" name="meta_instructor_assessable['+a.cid+']" value="1" '+CoursePress.utility.checked(d.instructor_assessable,1)+' /><span class="label">'+f.module_instructor_assessable+'</span><br /><span class="description">'+f.module_instructor_assessable_desc+"</span></label>"),e[d.type].excerpt&&"hidden"!==e[d.type].excerpt||!e[d.type].excerpt){var i="";i=0===parseInt(d.id)||_.isNaN(parseInt(d.id))?"post_content_"+(new Date).getTime():"post_content_"+d.id+"_"+(new Date).getTime();var j=i;c+='<div class="module module-excerpt"><h4 class="label">'+("input"===d.mode?f.module_question:f.module_content)+'</h4><span class="description">'+("input"===d.mode?f.module_question_desc:f.module_content_desc)+'</span><textarea class="editor" name="'+i+'" id="'+j+'" '+(d.editor_height?'data-height="'+d.editor_height+'"':"")+">"+d.content+"</textarea></div>"}c+="</div>",c+='<div class="module module-components">'+CoursePress.Helpers.Module.render_components(a,d)+"</div>"}return c+='<div class="unit-buttons"><div class="button unit-delete-module-button"><i class="fa fa-trash-o"></i> '+f.module_delete+"</div></div>",c+="</div>"},CoursePress.Helpers.Module.render_components=function(b,c){var d="",e=_.isArray(c.components)?c.components:[],f={};return a.each(e,function(c,e){var g=e.label?e.label:"",h=e.description?e.description:"",i=e.class?'class="'+e.class+'"':"",j=c,k="module-component-"+j;d+='<div class="module module-component '+k+'"><label data-key="label" '+i+'><span class="label">'+g+'</span><span class="description">'+h+"</span></label>";var l=_.isArray(e.items)?e.items:[];a.each(l,function(c,e){var g,h,i,j,l,m,n,o,p,q=e.type?e.type:"";switch(q){case"text-input":var r=e.name.replace("meta_","");r=b.get_meta(r),g=e.name?' name="'+e.name+'"':"",g+=e.class?' class="'+e.class+'"':"",o=e.label?e.label:"";var s=e.label_tag?e.label_tag:"";m=e.placeholder?e.placeholder:"",o.length>1&&(d+="<"+s+">"+o+"</"+s+">"),d+='<input type="text"'+g+' value="'+r+'" placeholder="'+m+'" />';break;case"text":g=e.class?' class="'+e.class+'"':"",h=e.text?e.text:"",d+="<div"+g+">"+h+"</div>";break;case"select-select":case"radio-select":i=e.name?e.name:"",g=e.class?' class="'+e.class+'"':"",j=b.get_meta("answers"),j=j.length>0?j:e.answers,l=b.get_meta("answers_selected",parseInt(e.selected)),d+='<div class="answer-group">',a.each(j,function(a,c){_.isNaN(parseInt(l))&&(l=l===c?a:l),y=i+"_selected["+b.cid+"]",d+='<div class="answer"><input type="radio" name="'+y+'" value="'+a+'" '+CoursePress.utility.checked(parseInt(l),a)+" />",d+='<input type="text" '+g+' value="'+c+'" name="'+i+'[]" /> <span class="remove-item"></span><i class="fa fa-trash-o"></i></span></div>'}),d+="</div>",d+='<a class="add-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"checkbox-select":i=e.name?e.name:"",g=e.class?' class="'+e.class+'"':"",j=b.get_meta("answers"),j=j.length>0?j:e.answers,l=b.get_meta("answers_selected"),l=l.length>0?l:e.selected,_.isNaN(parseInt(l[0]))&&a.each(l,function(a,b){l[a]=_.indexOf(j,b)}),d+='<div class="answer-group">',a.each(j,function(a,c){var e=_.indexOf(l,a)>-1?'checked="checked"':"";y=i+"_selected["+b.cid+"][]",d+='<div class="answer"><input type="checkbox" name="'+y+'" value="'+a+'" '+e+" />",d+='<input type="text" '+g+' value="'+c+'" name="'+i+'[]" /> <span class="remove-item"><i class="fa fa-trash-o"></i></span></div>'}),d+="</div>",d+='<a class="add-item">'+_coursepress.unit_builder_add_answer_label+"</a>";break;case"media-caption-settings":n=e.class?' class="'+e.class+'"':"";var t=e.option_class?' class="'+e.option_class+'"':"",u=e.label?e.label:"",v=e.option_labels?e.option_labels.media:"",w=e.option_labels?e.option_labels.custom:"";m=e.placeholder?e.placeholder:"";var x=e.enable_name?e.enable_name:"",y=e.option_name?e.option_name:"",z=e.input_name?e.input_name:"",A=e.no_caption?e.no_caption:"",B=b.get_meta(x),C=b.get_meta(y),D=b.get_meta(z);x=x+"["+b.cid+"]",y=y+"["+b.cid+"]",d+="<div "+n+'><label><input type="checkbox" value="1" name="'+x+'" '+CoursePress.utility.checked(B,1)+" /><span>"+u+"</span></label><div "+t+'><label><input type="radio" value="media" name="'+y+'" '+CoursePress.utility.checked(C,"media")+" /><span>"+v+'</span></label><div class="existing">'+A+'</div><label><input type="radio" value="custom" name="'+y+'" '+CoursePress.utility.checked(C,"custom")+" /><span>"+w+'</span></label><br /><input type="text" placeholder="'+m+'" value="'+D+'" name="'+z+'" /></div></div>',f.media_url&&f.media_url.length>0&&(CoursePress.utility.attachment_by_url(f.media_url,"."+k+" .existing",A),f.media_url=null);break;case"media-browser":var E=e.media_type?e.media_type:"image",F=e.class?e.class:"";n=e.container_class?e.container_class:"";var G=e.button_text?e.button_text:"";m=e.placeholder?e.placeholder:"",i=e.name?e.name:"",p=b.get_meta(i,""),d+=CoursePress.UI.browse_media_field(i,i,{value:p,type:E,container_class:n,textbox_class:F,placeholder:m,button_text:G}),f.media_url=p;break;case"checkbox":i=e.name?e.name:"",o=e.label?e.label:"",p=b.get_meta(i,""),y=i+"_selected["+b.cid+"]",d+='<label class="normal"><input type="checkbox" value="1" name="'+i+'" '+CoursePress.utility.checked(p,1)+" /><span>"+o+"</span></label>";break;case"action":var H=e.class||"",I=e.action||"",J=e.title||"",K=e.dashicon||"";d+='<div class="'+H+'" data-type="'+I+'"><a>',K&&(d+='<span class="dashicons dashicons-'+K+'"></span>'),d+="</a>",J&&(d+='<span class="element-label">'+J+"</span>"),d+="</div>";break;case"quiz":d+=CoursePress.Helpers.Module.quiz.render_component(b);break;case"form":d+=CoursePress.Helpers.Module.form.render_component(b)}}),d+="</div>"}),d},CoursePress.Views.UnitBuilder=Backbone.View.extend({initialize:function(){this.unit_collection=new CoursePress.Collections.UnitTabs,this.unit_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=units&course_id="+_coursepress.course_id,this.unit_collection.fetch(),this.module_collection=new CoursePress.Collections.UnitModules,this.tabViewCollection=new CoursePress.Views.UnitTabViewCollection({model:this.unit_collection,tagName:"ul",className:"sticky-tabs"}),this.tabViewCollection.parentView=this,this.headerView=new CoursePress.Views.UnitBuilderHeader,this.headerView.parentView=this,this.contentView=new CoursePress.Views.UnitBuilderBody({model:this.module_collection,className:"unit-builder-body"}),this.contentView.parentView=this,this.activePage=1,this.totalPages=1,this.activeUnitStatus="draft",this.activeModuleRef="",this.render()},events:{"click .unit-save-button":"saveUnit","change #unit-live-toggle":"toggleUnitState","change #unit-live-toggle-2":"toggleUnitState","click .unit-delete-module-button":"deleteModule","click .unit-delete-page-button":"deletePage","click .unit-delete-button":"deleteUnit","click .button-add-new-unit":"newUnit","click .unit-builder-tabs ul.sticky-tabs li":"changeActive","click .button-preview":"toPreview"},render:function(){var b=_.template(a("#unit-builder-template").html());return this.$el.html(b),this.$(".unit-builder-tabs .sticky-wrapper .tabs").replaceWith(this.tabViewCollection.el),this.$(".unit-builder-header").append(this.headerView.el),this.$(".unit-builder-body").replaceWith(this.contentView.el),a(".sticky-wrapper-tabs").sticky({topSpacing:45}),this},fetchModules:function(a,b){this.module_collection.url=_coursepress._ajax_url+"?action=unit_builder&task=modules&course_id="+_coursepress.course_id+"&unit_id="+a+"&page="+b,this.module_collection.fetch();var c=this.unit_collection._byId[this.activeUnitRef].get("meta");this.totalPages=c.page_title?c.page_title.length:1,this.totalPages=void 0===this.totalPages?_.size(c.page_title):1,this.activeModuleRef=""},userCap:function(a){return this.unit_collection._byId[this.activeUnitRef].get("user_cap")[a]},saveUnit:function(a){CoursePress.Helpers.Module.save_unit(a)},toggleUnitState:function(a){CoursePress.Helpers.Module.toggle_unit_state(a)},deleteModule:function(b){if(window.confirm(_coursepress.unit_builder_delete_module_confirm)){var c=b.currentTarget,d=a(c).parents(".module-holder")[0],e=a(d).attr("data-cid");this.module_collection.remove(e),a(d).parents(".group").detach()}},deletePage:function(a){var b=this;if(window.confirm(_coursepress.unit_builder_delete_page_confirm)){var c=parseInt(this.activePage);CoursePress.Helpers.Module.delete_page(a,b.activeUnitID,c),location.reload()}},deleteUnit:function(b){if(window.confirm(_coursepress.unit_builder_delete_unit_confirm)){this.unit_collection.remove(this.activeUnitRef),a('ul li[data-tab="'+this.activeUnitID+'"]').detach(),a(a(".unit-builder-body")[0]).empty(),a('.unit-detail input[type="text"]').val(""),a('.unit-detail input[type="checkbox"]').removeAttr("checked"),a("#unit-live-toggle").removeClass("on").addClass("off"),a("#unit-live-toggle-2").removeClass("on").addClass("off"),a(a('li[data-tab="units"] a')[0]).html(a(a('li[data-tab="units"] a')[0]).html().replace(/\d+/,a(".unit-builder-tabs ul li").length)),CoursePress.Helpers.Module.save_unit(b);var c=this.tabViewCollection.$el.find("li").last();c&&c.length>0&&c.trigger("click",c)}},newUnit:function(b){this.is_add=!0;var c=this,d=a(".unit-builder-tabs .sticky-tabs li").length,e=new CoursePress.Models.Unit;e.set_meta("unit_order",d+1),e.set_meta("page_title",{page_1:""}),e.set_meta("show_page_title",[!0]),e.set("post_title",_coursepress.unit_builder_new_unit_title),c.unit_collection.add(e),CoursePress.Helpers.Module.save_unit(b,"new_success");var f=new CoursePress.Views.UnitTabView({model:e,tagName:"li"}),g=f.render().$el;a(".button-add-new-unit .fa").removeClass("fa-plus-square").addClass("fa-spinner").addClass("fa-spin"),c.unit_collection.on("new_success",function(){c.unit_collection.fetch({success:function(){a(".button-add-new-unit .fa").removeClass("fa-spin").removeClass("fa-spinner").addClass("fa-plus-square"),a(".unit-builder-tabs ul.sticky-tabs").append(g),CoursePress.Helpers.Module.refresh_ui(),a(a('li[data-tab="units"] a')[0]).html(a(a('li[data-tab="units"] a')[0]).html().replace(/\d+/,a(".unit-builder-tabs ul li").length))}}),c.unit_collection.off("new_success")})},changeActive:function(b){a("#unit-builder .tab-tabs li").removeClass("active"),a(b.currentTarget).addClass("active");var c=a(b.currentTarget).attr("data-tab"),d=this;this.unit_collection.each(function(a){parseInt(c)===parseInt(a.get("ID"))&&CoursePress.Helpers.changeUnit(a,d)})},toPreview:function(b){var c=a(b.currentTarget),d=c.data("href");c.attr("href",d+this.activeUnitID)}}),CoursePress.Models.Unit=Backbone.Model.extend({initialize:function(){this.url=_coursepress._ajax_url+"?action=unit_builder&task=unit_update&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID,this.on("change",this.process_changed,this),this.on("sync",this.model_saved,this)},set_meta:function(a,b){a=a.replace("meta_","");var c=this.get("meta")||{};c[a]=b,this.set("flag","dirty"),this.set("meta",c),this.trigger("change",this)},set_page_title:function(a,b){var c=this.get("meta")||{};c.page_title=c.page_title||{},c.page_title["page_"+a]=b,this.set("meta",c),this.trigger("change",this)},set_page_description:function(a,b){var c=this.get("meta")||{};b=_.escape(b),c.page_description=c.page_description||{},c.page_description["page_"+a]=b,this.set("meta",c),this.trigger("change",this)},set_page_image:function(a,b){var c=this.get("meta")||{};c.page_feature_image=c.page_feature_image||{},c.page_feature_image["page_"+a]=b,this.set("meta",c),this.trigger("change",this)},set_page_visibility:function(a,b){var c=this.get("meta")||{},d=a-1;c.show_page_title&&(c.show_page_title[d]=b,this.set("meta",c),this.trigger("change",this))},get_page_title:function(a){var b=this.get("meta")||{};return b.page_title?b.page_title["page_"+a]:""},get_page_description:function(a){var b=this.get("meta")||{};return b.page_description?b.page_description["page_"+a]:""},get_page_image:function(a){var b=this.get("meta")||{};return b.page_feature_image?b.page_feature_image["page_"+a]:""},get_page_visibility:function(a){var b=this.get("meta")||{};return!b.show_page_title||b.show_page_title[a-1]},process_changed:function(){this.set("flag","dirty")},model_saved:function(){}}),CoursePress.Models.Module=Backbone.Model.extend({initialize:function(){var b=a("#unit-builder").attr("data-nonce");this.url=_coursepress._ajax_url+"?action=unit_builder&task=module_add&course_id="+_coursepress.course_id+"&unit_id="+CoursePress.UnitBuilder.activeUnitID+"&wp_nonce="+b,this.on("change",this.process_changed,this),this.on("sync",this.model_saved,this)},get_meta:function(a,b){a=a.replace("meta_",""),void 0===b&&(b="");var c=this.get("meta")||{},d=c[a]?c[a]:b,e=_.isString(d)?d.toLowerCase():d;return"yes"!==e&&"on"!==e&&"no"!==e&&"off"!==e||(d=this.fix_boolean(d)),c.legacy_updated||0!==d.length&&!1!==d&&0!==d||(d=this.get_legacy_meta(a,b)),d},get_legacy_meta:function(a,b){var c,d;switch(a){case"duration":a="time_estimation";break;case"show_title":a="show_title_on_front";break;case"mandatory":a="mandatory_answer";break;case"assessable":a="gradable_answer";break;case"minimum_grade":a="minimum_grade_required";break;case"allow_retries":return c=this.get("meta"),c.limit_attempts?(d=c.limit_attempts[0],!this.fix_boolean(d)):b;case"retry_attempts":a="limit_attempts_value";break;case"order":a="module_order";break;case"page":a="module_page";break;case"answers_selected":a="input-radio"===this.module_type()?"checked_answer":"checked_answers"}return c=this.get("meta")||{},d=c[a]?c[a]:b},fix_legacy_module:function(a){var b=this,c=b.get("meta");if(b.set("flag","dirty"),c.module_type=a,c.checked_answer&&(c.answers_selected=c.checked_answer),c.checked_answers&&(c.answers_selected=c.checked_answers),c.time_estimation&&(c.duration=c.time_estimation),c.show_title_on_front&&(c.show_title=b.fix_boolean(c.show_title_on_front)),c.mandatory_answer&&(c.mandatory=b.fix_boolean(c.mandatory_answer)),c.gradable_answer&&(c.assessable=b.fix_boolean(c.gradable_answer)),c.minimum_grade_required&&(c.minimum_grade=c.minimum_grade_required),c.limit_attempts){var d=b.fix_boolean(c.limit_attempts);c.allow_retries=!d}c.limit_attempts_value&&(c.retry_attempts=c.limit_attempts_value),b.set("meta",c)},map_legacy_type:function(a){var b=this,c={audio_module:"audio",chat_module:"chat",checkbox_input_module:"input-checkbox",file_module:"download",file_input_module:"input-upload",image_module:"image",radio_input_module:"input-radio",page_break_module:"section",section_break_module:"section",text_module:"text",text_input_module:"input-text",textarea_input_module:"input-textarea",video_module:"video"};return a in c&&(a="single"!==this.get_meta("checked_length","single")?"input-textarea":c[a],b.fix_legacy_module(a)),a},module_type:function(){return this.map_legacy_type(this.get_meta("module_type"))},fix_boolean:function(a){var b=_.isString(a)?a.toLowerCase():a;return 1===parseInt(b)||"on"===b||"yes"===b||!0===b},set_meta:function(a,b){a=a.replace("meta_","");var c=this.get("meta")||{};c[a]=b,this.set("flag","dirty"),this.set("meta",c),this.trigger("change",this)},from_template:function(b){var c=JSON.parse(_coursepress.unit_builder_templates[b]);this.set("ID",c.id),this.set("post_title",c.title),this.set_meta("duration",c.duration||"1:00"),this.set_meta("module_type",c.type),this.set_meta("mandatory",c.mandatory),this.set_meta("show_title",c.show_title||!0),this.set_meta("assessable",c.assessable),this.set_meta("minimum_grade",c.minimum_grade),this.set_meta("allow_retries",c.allow_retries),this.set_meta("retry_attempts",c.retry_attempts),"input-quiz"===c.type&&this.set_meta("use_timer",c.use_timer),"input-form"===c.type&&this.set_meta("use_timer",c.use_timer),this.set("post_content",c.content||""),this.set_meta("order",c.order);var d=this;a.each(c.components,function(b,c){a.each(c.items,function(a,b){d.item_to_meta(b)})})},item_to_meta:function(a){var b=this;switch(a.type){case"media-browser":case"text-input":b.set_meta(a.name,"");break;case"checkbox-select":case"select-select":case"radio-select":b.set_meta(a.name,a.answers),b.set_meta(a.name+"_selected",a.selected);break;case"media-caption-settings":b.set_meta(a.enable_name,!1),b.set_meta(a.option_name,"media"),b.set_meta(a.input_name,"");break;case"checkbox":b.set_meta(a.name,!1)}},model_saved:function(a){CoursePress.UnitBuilder.activeModuleRef=a.cid,CoursePress.UnitBuilder.gotoAdded=!0},process_changed:function(){CoursePress.UnitBuilder.activeModuleRef=this.cid,this.set("flag","dirty")}}),CoursePress.Collections.UnitTabs=Backbone.Collection.extend({model:CoursePress.Models.Unit}),CoursePress.Collections.UnitModules=Backbone.Collection.extend({model:CoursePress.Models.Module}),CoursePress.Views.UnitTabView=Backbone.View.extend({render:function(){var b=this.model.get("post_status"),c=this.model.get("meta"),d={unit_id:this.model.get("ID"),unit_title:this.model.get("post_title"),unit_live_class:"publish"===b?"unit-live":"unit-draft",unit_active_class:this.first?"active":"",unit_order:c.unit_order,unit_cid:this.model.cid},e=_.template(a("#unit-builder-tab-template").html());return this.$el=e(d),this}}),CoursePress.Views.UnitTabViewCollection=Backbone.View.extend({initialize:function(){this.model.on("sync",this.render,this)},events:{},render:function(){var a=this;a.$el.empty();var b=0,c=this.model.length;return this.parentView.is_add&&(b=c-1),this.model.each(function(c,d){var e=new CoursePress.Views.UnitTabView({model:c,tagName:"li"});e.first=b===d,a.$el.append(e.render().$el),b===d?CoursePress.Helpers.changeUnit(c,a):(a.parentView.contentView.initial=!0,a.parentView.contentView.render())}),this.model.trigger("rendered",this.model),this},changeActive:function(b){a("#unit-builder .tab-tabs li").removeClass("active"),a(b.currentTarget).addClass("active");var c=a(b.currentTarget).attr("data-tab"),d=this;this.model.each(function(b){parseInt(c)===parseInt(b.get("ID"))&&(CoursePress.Helpers.changeUnit(b,d),a("body,html").animate({scrollTop:a(".section.unit-builder-header").offset().top-20,duration:200}))})}}),CoursePress.Helpers.changeUnit=function(a,b,c){b=CoursePress.UnitBuilder,void 0===c&&(c=1),b.activePage=c,b.headerView.template_variables.unit_id=a.get("ID"),b.headerView.template_variables.unit_cid=a.cid,b.headerView.template_variables.unit_title=a.get("post_title"),b.headerView.template_variables.unit_content=a.get("post_content");var d=a.get("meta");b.headerView.template_variables.unit_availability=d.unit_availability,b.headerView.template_variables.unit_date_availability=d.unit_date_availability?d.unit_date_availability:"",b.headerView.template_variables.unit_delay_days=d.unit_delay_days?d.unit_delay_days:0,b.headerView.template_variables.unit_feature_image=d.unit_feature_image;var e=d.force_current_unit_completion;e="on"===e||!0===e||1===parseInt(e)?'checked="checked"':"",b.headerView.template_variables.unit_force_completion_checked=e,e=d.force_current_unit_successful_completion,e="on"===e||!0===e||1===parseInt(e)?'checked="checked"':"",b.headerView.template_variables.unit_force_successful_completion_checked=e,b.headerView.render(),b.headerView.$el.find('[name="meta_unit_availability"]').trigger("change",b.headerView),b.contentView.initial=!0,b.contentView.render(),b.activeUnitID=a.get("ID"),b.activeUnitRef=a.cid,b.activeUnitStatus=a.get("post_status"),b.fetchModules(b.activeUnitID,b.activePage);var f=a.get("user_cap"),g=b.$el.find(".unit-builder-no-access");f.coursepress_update_course_unit_cap?(b.headerView.$el.show(),b.contentView.$el.show(),g.hide()):(b.headerView.$el.hide(),b.contentView.$el.hide(),g.show())},CoursePress.Views.UnitBuilderHeader=Backbone.View.extend({initialize:function(){this.template_variables={unit_id:"",unit_cid:"",unit_title:"",unit_content:"",unit_feature_image:"",unit_availability:"",unit_date_availability:"",unit_delay_days:0,unit_force_completion_checked:"",unit_force_successful_completion_checked:""},this.render(),CoursePress.Events.on("editor:keyup",this.editorChanged,this)},events:{"change .unit-detail input":"fieldChanged","keyup .unit-detail input[name=post_title]":"updateTabTitle","keyup .unit-detail #unit_description_1_1":"editorChanged","change #unit-live-toggle":"toggleUnitState","change #unit-live-toggle-2":"toggleUnitState","change #unit_feature_image":"unitFeatureImageChange",'change [name="unit_feature_image-button"]':"unitFeatureImageChange",'change [name="meta_unit_availability"]':"toggleAvailability",'focus [name="meta_unit_date_availability"]':"setDate","change select":"fieldChanged"},render:function(){var b=this.template_variables;0===parseInt(b.unit_delay_days)&&(b.unit_delay_days="");var c=_.template(a("#unit-builder-header-template").html());return this.$el.html(c(b)),a("#unit_feature_image").val(b.unit_feature_image),this.updateUnitHeader(),this},editorChanged:function(b){var c=b.id;if(void 0===c&&(c=a(b.currentTarget).attr("id")),void 0!==c&&"unit_description_1_1"===c){var d=a("#"+c),e=CoursePress.editor.content(c),f=a(d).parents(".unit-detail")[0],g=this.parentView.unit_collection._byId[a(f).attr("data-cid")];e=_.escape(e),g.set("post_content",e)}},fieldChanged:function(b){var c=a(b.currentTarget),d=a(c).attr("name");if("unit_feature_image"!==d&&"unit_feature_image-button"!==d&&"page_feature_image"!==d&&"page_feature_image-button"!==d){var e=a(c).val(),f=a(c).parents(".unit-detail")[0],g=this.parentView.unit_collection._byId[a(f).attr("data-cid")];"checkbox"===a(c).attr("type")&&(e=a(c).is(":checked")),g&&(/meta_/.test(d)?g.set_meta(d,e):g.set(d,e))}},unitFeatureImageChange:function(b){var c=a(b.currentTarget),d=a("#unit_feature_image").val(),e=c.parents(".unit-detail").first();this.parentView.unit_collection._byId[e.attr("data-cid")].set_meta("unit_feature_image",d)},updateTabTitle:function(b){a('[data-tab="'+this.parentView.activeUnitID+'"] span').html(a(b.currentTarget).val())},toggleUnitState:function(a){CoursePress.Helpers.Module.toggle_unit_state(a)},updateUnitHeader:function(){a.each(a("#unit_description_1_1"),function(b,c){var d=a(c).attr("id");delete tinyMCEPreInit.mceInit[d],delete tinyMCEPreInit.qtInit[d],delete tinyMCE.EditorManager.editors[d];var e=a("#"+d).val(),f=a(c).attr("name"),g=a(c).attr("data-height")?a(c).attr("data-height"):200;CoursePress.editor.create(c,d,f,e,!1,g)})},toggleAvailability:function(b){var c=a(b.currentTarget),d=c.val(),e=c.parent().find(".ua-div"),f=c.parent().find(".div-"+d);e.hide(),f.length>0&&f.show()},setDate:function(b){a(b.target).datepicker()}}),CoursePress.Views.UnitBuilderFooter=Backbone.View.extend({render:function(){var b=_.template(a("#unit-builder-footer-template").html());return this.$el.empty(),this.$el.html(b),this}}),CoursePress.Views.UnitBuilderBody=Backbone.View.extend({initialize:function(){this.initial=!0,this.pagerView=new CoursePress.Views.UnitBuilderPager({className:"section unit-builder-pager"}),this.pagerView.parentView=this,this.pagerView.template_variables={},this.pagerViewInfo=new CoursePress.Views.UnitBuilderPagerInfo({className:"section unit-builder-pager-info"}),this.pagerViewInfo.parentView=this,this.pagerViewInfo.template_variables={},this.componentsView=new CoursePress.Views.UnitBuilderComponents({className:"section unit-builder-components"}),this.componentsView.parentView=this,this.componentsView.template_variables={},this.modulesView=new CoursePress.Views.UnitBuilderModules({className:"section unit-builder-modules"}),this.modulesView.parentView=this,this.modulesView.template_variables={},this.footerView=new CoursePress.Views.UnitBuilderFooter({className:"unit-buttons"}),this.footerView.parentView=this,this.model.on("sync",this.render,this),CoursePress.Events.on("editor:keyup",this.editorChanged,this)},render:function(){var b;if(this.initial)b=_.template(a("#unit-builder-content-placeholder").html()),this.$el.html(b),this.initial=!1;else{b=_.template(a("#unit-builder-content-template").html()),this.$el.html(b);var c=this.parentView.unit_collection._byId[this.parentView.activeUnitRef];this.pagerView.template_variables.unit_page_count=this.parentView.totalPages,this.pagerView.template_variables.pages_titles=c.attributes.meta.page_title,this.$(".unit-builder-pager").replaceWith(this.pagerView.render(this.pagerView.template_variables).el),c=this.parentView.unit_collection._byId[this.parentView.activeUnitRef];var d=c.get_page_visibility(this.parentView.activePage);if(d=!d&&!1!==d||(_.isString(d)&&("yes"===d.toLowerCase()||"on"===d.toLowerCase())||1===parseInt(d)||!0===d),this.pagerViewInfo.template_variables={page_label_text:c.get_page_title(this.parentView.activePage),page_description:c.get_page_description(this.parentView.activePage),page_feature_image:c.get_page_image(this.parentView.activePage),page_label_checked:d?'checked="checked"':""},this.$(".unit-builder-pager-info").replaceWith(this.pagerViewInfo.render(this.pagerViewInfo.template_variables).el),this.componentsView.template_variables={},this.$(".unit-builder-components").replaceWith(this.componentsView.render(this.componentsView.template_variables).el),this.$(".unit-builder-modules").replaceWith(this.modulesView.render(this.parentView.module_collection.models).el),this.$(".unit-builder-footer").append(this.footerView.render().el),CoursePress.Helpers.Module.refresh_ui(),this.updateSectionEditor(),a("#page_feature_image").val(this.pagerViewInfo.template_variables.page_feature_image),!0===CoursePress.UnitBuilder.gotoAdded){CoursePress.UnitBuilder.gotoAdded=!1;var e=a("[data-cid="+CoursePress.UnitBuilder.activeModuleRef+"]");a("body,html").scrollTop(a(e).offset().top-80)}}return a(".page-info-holder input[name=page_title]").on("keyup",function(){label=a(this).val(),label=label.length>19?label.substr(0,19)+"…":label,a(".unit-builder-pager li.active").html(label)}),this},events:{"click .unit-builder-components .output-element":"add_element","click .unit-builder-components .input-element":"add_element","change .button.browse-media-field":"fieldChanged","change .module-holder input":"fieldChanged","change textarea":"fieldChanged","change select":"selectionChanged","change .page-info-holder input":"unitPageInfoChanged","keyup .module-title-text":"updateUIHeading","click .unit-builder-pager ul li":"changePage","click .module-component .add-item":"addAnswer","click .module-component .remove-item":"removeAnswer","change #page_feature_image":"pageFeatureImageChange",'change [name="page_feature_image-button"]':"pageFeatureImageChange"},pageFeatureImageChange:function(b){var c=a(b.currentTarget),d=a("#page_feature_image").val(),e=this.parentView.activePage,f=a(a(c).parents(".unit-builder-content")[0]).find(".unit-detail")[0];this.parentView.unit_collection._byId[a(f).attr("data-cid")].set_page_image(e,d)},add_element:function(b){CoursePress.Helpers.Module.unit_add_show_message('<i class="fa fa-circle-o-notch fa-spin"></i> '+_coursepress.unit_builder_form.messages.adding_module,"info");var c=b.currentTarget,d=a(c).attr("class").match(/module-(\w|-)*/g)[0].trim().replace("module-",""),e=a(".module-holder").length,f=new CoursePress.Models.Module;f.from_template(d),f.set_meta("module_order",e+1),f.set_meta("module_page",this.parentView.activePage),f.save(null,{success:function(b,c){a(".section.unit-builder-components .notice").detach()}}),this.parentView.module_collection.add(f)},fieldChanged:function(b){var c=a(b.currentTarget),d=a(c).attr("name");if("unit_feature_image"!==d&&"unit_feature_image-button"!==d&&"page_feature_image"!==d&&"page_feature_image-button"!==d){var e,f=a(c).val(),g=a(c).parents(".module-holder")[0],h=this.parentView.module_collection._byId[a(g).attr("data-cid")],i=a(c).attr("type");if("checkbox"===i&&(e=a('[name="'+d+'"]'),d=d.replace(/\[.*\]/,""),e.length>1?(f=[],a.each(e,function(b,c){a(c).is(":checked")&&f.push(b)})):f=a(c).is(":checked")),"radio"===i&&(d=d.replace(/\[.*\]/,"")),("text"===i||"textbox"===i)&&/\[\]/.test(d)){var j=a(c).parents(".module-component");if(j.length>0)return e=a(j).find('[name="'+d+'"]'),d=d.replace(/\[.*\]/,""),f=[],a.each(e,function(b,c){f.push(a(c).val())}),void h.set_meta(d,f)}if("button"===i&&a(c).hasClass("browse-media-field")){var k=a(a(c)[0]).siblings("[type=text]")[0];d=a(k).attr("name"),f=a(k).val()}/meta_/.test(d)?h.set_meta(d,f):h.set(d,f)}},selectionChanged:function(b){var c=a(b.currentTarget),d=a(c).attr("name"),e=a(c).val(),f=a(c).parents(".module-holder")[0],g=this.parentView.module_collection._byId[a(f).attr("data-cid")];/meta_/.test(d)?g.set_meta(d,e):g.set(d,e)},editorChanged:function(b){var c=b.id,d=a("#"+c).parents(".module-holder")[0];if(void 0!==d){var e=this.parentView.module_collection._byId[a(d).attr("data-cid")],f=/post_content_/.test(c)?c.replace(/(_\d+)+$/,""):c,g=CoursePress.editor.content(c);/meta_/.test(f)?e.set_meta(f,g):e.set(f,g)}},updateUIHeading:function(b){var c=a(b.currentTarget),d=a(c.parents(".module-holder").first()).siblings("h3").first();a(d).find(".label").html(c.val())},changePage:function(b){var c=this,d=a(b.currentTarget).attr("data-page"),e=c.parentView.unit_collection._byId[c.parentView.activeUnitRef];d?(c.parentView.activePage=a(b.currentTarget).attr("data-page"),c.parentView.fetchModules(c.parentView.activeUnitID,c.parentView.activePage)):(c.parentView.activePage=a(".unit-builder-pager ul li").length,c.parentView.totalPages=c.parentView.activePage,e.set_page_title(c.parentView.activePage,""),e.set_page_visibility(c.parentView.activePage,!0),c.parentView.fetchModules(c.parentView.activeUnitID,c.parentView.activePage))},unitPageInfoChanged:function(b){var c=a(b.currentTarget),d=a(c).attr("name"),e=a(c).val(),f=this.parentView.unit_collection._byId[this.parentView.activeUnitRef];switch("checkbox"===a(c).attr("type")&&(e=a(c).is(":checked")),d){case"page_title":f.set_page_title(this.parentView.activePage,e);break;case"show_page_title":f.set_page_visibility(this.parentView.activePage,e)}f.trigger("change",f)},addAnswer:function(b){var c=b.currentTarget,d=a(c).siblings(".answer-group"),e=a(c).parents(".module-holder"),f=a(e).attr("data-cid"),g=a(e).find(".answer"),h=g.length,i=a(a(c).parents(".module-holder")[0]).attr("class").match(/input-radio|input-select/)?"radio":"checkbox",j=a(a(c).parents(".module-holder")[0]).attr("class").match(/input-radio|input-select/)?"meta_answers_selected["+f+"]":"meta_answers_selected["+f+"][]";a(d).append('<div class="answer"><input type="'+i+'" value="'+h+'" name="'+j+'"><input class="component-'+i+'-answer wide" type="text" name="meta_answers[]" value=""> <span class="remove-item"><i class="fa fa-trash-o"></i></span></div>')},removeAnswer:function(b){var c=b.currentTarget,d=a(c).parents(".answer-group"),e=a(c).parents(".answer"),f=a(c).parents(".module-holder"),g=a(f).attr("data-cid"),h=this.parentView.module_collection._byId[g];e.detach();var i=a(d).find('[name="meta_answers_selected['+g+'][]"]'),j=[];a.each(i,function(b,c){a(c).is(":checked")&&j.push(b),a(c).val(b)}),h.set_meta("meta_answers_selected",j),i=a(d).find('[name="meta_answers[]"]'),j=[],a.each(i,function(b,c){j.push(a(c).val())}),h.set_meta("meta_answers",j)},updateSectionEditor:function(){a.each(a("#page_description_1_1"),function(b,c){var d=a(c).attr("id");delete tinyMCEPreInit.mceInit[d],delete tinyMCEPreInit.qtInit[d],delete tinyMCE.EditorManager.editors[d];var e=a("#"+d).val(),f=a(c).attr("name"),g=a(c).attr("data-height")?a(c).attr("data-height"):200;CoursePress.editor.create(c,d,f,e,!1,g)})}}),CoursePress.Views.UnitBuilderPager=Backbone.View.extend({render:function(b){var c=_.template(a("#unit-builder-pager-template").html());return this.$el.html(c(b)),this}}),CoursePress.Views.UnitBuilderPagerInfo=Backbone.View.extend({initialize:function(){CoursePress.Events.on("editor:keyup",this.editorChanged,this)},events:{"change .page-info-holder input":"fieldChanged","keyup .unit-detail #page_description_1_1":"editorChanged"},render:function(b){var c=_.template(a("#unit-builder-pager-info-template").html());return this.$el.html(c(b)),this},editorChanged:function(b){var c=this.parentView.parentView.activePage,d=b.id;if(void 0===d&&(d=a(b.currentTarget).attr("id")),void 0!==d&&"page_description_1_1"===d){var e=a("#"+d),f=CoursePress.editor.content(d),g=a(a(e).parents(".unit-builder-content")[0]).find(".unit-detail")[0];this.parentView.parentView.unit_collection._byId[a(g).attr("data-cid")].set_page_description(c,f)}}}),CoursePress.Views.UnitBuilderComponents=Backbone.View.extend({render:function(b){var c=_.template(a("#unit-builder-components-template").html());return this.$el.html(c(b)),this}}),CoursePress.Views.UnitBuilderModules=Backbone.View.extend({render:function(){var a=this;return a.$el.empty(),this.parentView.model.each(function(b){var c=new CoursePress.Views.ModuleView({model:b,tagName:"div",className:"group group-"+b.module_type()}),d=b.get_meta("module_order");a.$el.append(c.render(b,d).$el)}),this}}),CoursePress.Views.ModuleView=Backbone.View.extend({render:function(a,b){var c=this;return c.$el.empty(),c.$el.append(CoursePress.Helpers.Module.render_module(a,b)),CoursePress.Helpers.Module.refresh_ui(),this}}),a(document).ready(b)}(jQuery);